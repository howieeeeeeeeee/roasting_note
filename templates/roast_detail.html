{% extends "base.html" %}

{% block title %}{{ roast.title }} - RoastLogger{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ roast.title }}</h1>
    <div class="header-actions">
        <a href="{{ url_for('roast_edit_form', roast_id=roast._id) }}" class="btn btn-primary">Edit Roast</a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
</div>

<div class="roast-detail">
    <section class="detail-section">
        <h2>Basic Information</h2>
        <div class="detail-grid">
            <div class="detail-item">
                <strong>Bean:</strong> {{ roast.bean_name }}
            </div>
            <div class="detail-item">
                <strong>Roast Date:</strong> {{ roast.roast_date | format_date }}
            </div>
            <div class="detail-item">
                <strong>Roaster:</strong> {{ roast.roaster or 'Not specified' }}
            </div>
            <div class="detail-item">
                <strong>Temperature Method:</strong> {{ roast.temp_measurement_method or 'Not specified' }}
            </div>
        </div>
    </section>

    <section class="detail-section">
        <h2>Weights & Loss</h2>
        <div class="detail-grid">
            <div class="detail-item">
                <strong>Green Weight:</strong> {{ roast.original_weight_grams or 'Not set' }}{% if roast.original_weight_grams %}g{% endif %}
            </div>
            <div class="detail-item">
                <strong>Roasted Weight:</strong> {{ roast.roasted_weight_grams or 'Not set' }}{% if roast.roasted_weight_grams %}g{% endif %}
            </div>
            <div class="detail-item">
                <strong>Weight Loss:</strong> {{ roast.weight_loss_percentage or 'N/A' }}{% if roast.weight_loss_percentage %}%{% endif %}
            </div>
        </div>
    </section>

    <section class="detail-section">
        <h2>Roast Duration</h2>
        <div class="detail-grid">
            <div class="detail-item">
                <strong>Start Time:</strong> {{ roast.roast_start_time | format_date if roast.roast_start_time else 'Not started' }}
            </div>
            <div class="detail-item">
                <strong>End Time:</strong> {{ roast.roast_end_time | format_date if roast.roast_end_time else 'Not ended' }}
            </div>
            <div class="detail-item">
                <strong>Duration:</strong> {{ roast.roast_duration_seconds | format_seconds if roast.roast_duration_seconds else 'N/A' }}
            </div>
        </div>
    </section>

    {% if roast.key_timings or roast.temp_curve %}
    <section class="detail-section">
        <h2>Roast Events</h2>
        <div class="table-wrapper">
            <table class="data-table combined-events-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event / Note</th>
                        <th>Temp (°C)</th>
                        <th>Fan</th>
                        <th>Power</th>
                    </tr>
                </thead>
                <tbody>
                    {% set all_events = [] %}

                    {# Collect key timings #}
                    {% for timing in roast.key_timings %}
                        {% set _ = all_events.append({
                            'time': timing.time_seconds,
                            'type': 'key',
                            'event_name': timing.event_name,
                            'temperature': timing.get('temperature'),
                            'fan_setting': timing.get('fan_setting'),
                            'power_setting': timing.get('power_setting')
                        }) %}
                    {% endfor %}

                    {# Collect temperature curve events #}
                    {% for event in roast.temp_curve %}
                        {% set _ = all_events.append({
                            'time': event.time_seconds,
                            'type': 'temp',
                            'note': event.get('note', ''),
                            'temperature': event.temperature,
                            'fan_setting': event.fan_setting,
                            'power_setting': event.power_setting
                        }) %}
                    {% endfor %}

                    {# Sort all events by time #}
                    {% for event in all_events | sort(attribute='time') %}
                    <tr class="{% if event.type == 'key' %}event-row-key{% else %}event-row-temp{% endif %}">
                        <td class="event-time">{{ event.time | format_seconds }}</td>
                        <td class="event-description">
                            {% if event.type == 'key' %}
                                <strong class="key-event-name">{{ event.event_name }}</strong>
                            {% else %}
                                {% if event.note %}
                                    <span class="temp-note">{{ event.note }}</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if event.temperature %}
                                {{ event.temperature }}°C
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if event.fan_setting is not none %}
                                {{ event.fan_setting }}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if event.power_setting is not none %}
                                {{ event.power_setting }}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}

    {% if roast.general_notes %}
    <section class="detail-section">
        <h2>General Notes</h2>
        <div class="notes-content markdown-content" id="generalNotes" data-markdown="{{ roast.general_notes }}"></div>
    </section>
    {% endif %}

    <section class="detail-section">
        <h2>Reviews</h2>
        {% if roast.reviews %}
        <div class="reviews-overview">
            {% for review in roast.reviews %}
            <div class="review-overview-card" onclick="showReviewModal('{{ review._id }}', 'view')">
                <div class="review-overview-header">
                    <div class="review-rating">
                        {% set score = review.overall_score if review.overall_score else review.get('rating', 3) %}
                        {% for i in range(score) %}★{% endfor %}
                        {% for i in range(5 - score) %}☆{% endfor %}
                    </div>
                    <span class="review-date">{{ review.review_date.strftime('%Y-%m-%d') if review.review_date else 'N/A' }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No reviews yet.</p>
        {% endif %}

        <button class="btn btn-primary btn-full-width" onclick="showReviewModal(null, 'create')">Add Review</button>
    </section>
</div>

<!-- Review Modal -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Review</h2>
            <span class="modal-close" onclick="closeReviewModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="viewMode" style="display: none;">
                <div class="review-detail">
                    <div class="detail-item">
                        <strong>Overall Score:</strong>
                        <div class="review-rating-display" id="viewOverallScore"></div>
                    </div>
                    <div class="detail-item">
                        <strong>Extraction Method:</strong>
                        <span id="viewExtractionMethod"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Date:</strong>
                        <span id="viewDate"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Notes:</strong>
                        <div class="notes-content" id="viewNotes"></div>
                    </div>
                    <div class="detail-item" id="viewUpdatedAtContainer" style="display: none;">
                        <strong>Last Updated:</strong>
                        <span id="viewUpdatedAt"></span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary btn-full-width" onclick="switchToEditMode()">Edit</button>
                    <button class="btn btn-danger btn-full-width" onclick="deleteReview()">Delete</button>
                </div>
            </div>

            <div id="formMode" style="display: none;">
                <form id="reviewForm" onsubmit="submitReview(event)">
                    <div class="form-group">
                        <label for="overall_score">Overall Score <span style="color: red;">*</span></label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="overall_score" value="1" required>
                                <span class="radio-custom">1 ★</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="overall_score" value="2">
                                <span class="radio-custom">2 ★★</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="overall_score" value="3">
                                <span class="radio-custom">3 ★★★</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="overall_score" value="4">
                                <span class="radio-custom">4 ★★★★</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="overall_score" value="5">
                                <span class="radio-custom">5 ★★★★★</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="extraction_method">Extraction Method <span style="color: red;">*</span></label>
                        <select id="extraction_method" name="extraction_method" required>
                            <option value="">Select method</option>
                            <option value="espresso">Espresso</option>
                            <option value="pourover">Pourover</option>
                            <option value="ice_drop">Ice Drop</option>
                            <option value="cold_brew">Cold Brew</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="4" placeholder="Flavor profile, tasting notes, brew details, etc."></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary btn-full-width">Save</button>
                        <button type="button" class="btn btn-secondary btn-full-width" onclick="closeReviewModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const roastId = '{{ roast._id }}';
    let currentReviewId = null;
    let currentMode = null;

    // Store reviews data for JavaScript access
    const reviewsData = {
        {% for review in roast.reviews %}
        '{{ review._id }}': {
            overall_score: {{ review.overall_score if review.overall_score else review.get('rating', 3) }},
            extraction_method: '{{ review.get('extraction_method', '') }}',
            notes: {{ review.notes | tojson }},
            review_date: '{{ review.review_date.strftime('%Y-%m-%d %H:%M') if review.review_date else '' }}',
            updated_at: '{{ review.updated_at.strftime('%Y-%m-%d %H:%M') if review.get('updated_at') and review.updated_at != review.created_at else '' }}'
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    function showReviewModal(reviewId, mode) {
        currentReviewId = reviewId;
        currentMode = mode;

        const modal = document.getElementById('reviewModal');
        const viewMode = document.getElementById('viewMode');
        const formMode = document.getElementById('formMode');
        const modalTitle = document.getElementById('modalTitle');

        if (mode === 'view' && reviewId) {
            const review = reviewsData[reviewId];
            modalTitle.textContent = 'Review Details';

            // Populate view mode
            document.getElementById('viewOverallScore').innerHTML = '★'.repeat(review.overall_score) + '☆'.repeat(5 - review.overall_score) + ' (' + review.overall_score + ' / 5)';
            document.getElementById('viewExtractionMethod').textContent = formatExtractionMethod(review.extraction_method);
            document.getElementById('viewDate').textContent = review.review_date;
            document.getElementById('viewNotes').textContent = review.notes || 'No notes';

            if (review.updated_at) {
                document.getElementById('viewUpdatedAt').textContent = review.updated_at;
                document.getElementById('viewUpdatedAtContainer').style.display = 'block';
            } else {
                document.getElementById('viewUpdatedAtContainer').style.display = 'none';
            }

            viewMode.style.display = 'block';
            formMode.style.display = 'none';
        } else if (mode === 'create') {
            modalTitle.textContent = 'Add Review';
            document.getElementById('reviewForm').reset();
            viewMode.style.display = 'none';
            formMode.style.display = 'block';
        } else if (mode === 'edit' && reviewId) {
            modalTitle.textContent = 'Edit Review';
            const review = reviewsData[reviewId];

            // Populate form with existing data
            document.querySelector(`input[name="overall_score"][value="${review.overall_score}"]`).checked = true;
            document.getElementById('extraction_method').value = review.extraction_method;
            document.getElementById('notes').value = review.notes;

            viewMode.style.display = 'none';
            formMode.style.display = 'block';
        }

        modal.style.display = 'block';
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
        currentReviewId = null;
        currentMode = null;
    }

    function switchToEditMode() {
        showReviewModal(currentReviewId, 'edit');
    }

    async function submitReview(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = {
            overall_score: parseInt(formData.get('overall_score')),
            extraction_method: formData.get('extraction_method'),
            notes: formData.get('notes')
        };

        try {
            let url, method;
            if (currentMode === 'create') {
                url = `/api/roast/add_review/${roastId}`;
                method = 'POST';
            } else if (currentMode === 'edit') {
                url = `/api/roast/update_review/${roastId}/${currentReviewId}`;
                method = 'POST';
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to save review');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while saving the review');
        }
    }

    async function deleteReview() {
        if (!confirm('Are you sure you want to delete this review?')) {
            return;
        }

        try {
            const response = await fetch(`/api/roast/delete_review/${roastId}/${currentReviewId}`, {
                method: 'POST'
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to delete review');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the review');
        }
    }

    function formatExtractionMethod(method) {
        const methods = {
            'espresso': 'Espresso',
            'pourover': 'Pourover',
            'ice_drop': 'Ice Drop',
            'cold_brew': 'Cold Brew',
            'other': 'Other'
        };
        return methods[method] || method || 'Not specified';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('reviewModal');
        if (event.target === modal) {
            closeReviewModal();
        }
    }

    // Render markdown for general notes
    document.addEventListener('DOMContentLoaded', function() {
        const generalNotesDiv = document.getElementById('generalNotes');
        if (generalNotesDiv && typeof marked !== 'undefined') {
            const markdownText = generalNotesDiv.getAttribute('data-markdown');
            if (markdownText) {
                generalNotesDiv.innerHTML = marked.parse(markdownText);
            }
        }
    });
</script>
{% endblock %}
